<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Fangwen - ÁÆ°ÁêÜÁïåÈù¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .url-list {
            padding: 1.5rem;
        }

        .url-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .url-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
        }

        .url-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .url-id {
            font-weight: 600;
            color: #333;
        }

        .url-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-enabled {
            background: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .url-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            color: #666;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            word-break: break-all;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            margin: 5% auto;
            position: relative;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                padding: 0 0.5rem;
            }

            .url-details {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }

        /* Êó•ÂøóÂÆπÂô®Ê†∑Âºè */
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #fff;
            padding: 1rem;
        }

        /* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè */
        .logs-container::-webkit-scrollbar {
            width: 8px;
        }

        .logs-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .logs-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .logs-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>ü§ñ Auto-Fangwen</h1>
                <span>ÂÆöÊó∂ËÆøÈóÆURLÁÆ°ÁêÜÁ≥ªÁªü</span>
            </div>
            <div class="user-info">
                <span>ÁÆ°ÁêÜÂëò</span>
                <button class="btn btn-secondary btn-sm" id="logoutBtn">ÈÄÄÂá∫ÁôªÂΩï</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ÁªüËÆ°‰ø°ÊÅØ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalUrls">0</div>
                <div class="stat-label">ÊÄªURLÊï∞Èáè</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enabledUrls">0</div>
                <div class="stat-label">ÂêØÁî®‰ªªÂä°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="disabledUrls">0</div>
                <div class="stat-label">Á¶ÅÁî®‰ªªÂä°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="systemStatus">ËøêË°å‰∏≠</div>
                <div class="stat-label">Á≥ªÁªüÁä∂ÊÄÅ</div>
            </div>
        </div>

        <!-- URLÈÖçÁΩÆÁÆ°ÁêÜ -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">URLÈÖçÁΩÆÁÆ°ÁêÜ</h2>
                <div>
                    <button class="btn btn-primary" id="addUrlBtn">
                        ‚ûï Ê∑ªÂä†URL
                    </button>
                    <button class="btn btn-secondary" id="refreshDataBtn">
                        üîÑ Âà∑Êñ∞
                    </button>
                </div>
            </div>
            <div class="url-list" id="urlList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Ê≠£Âú®Âä†ËΩΩURLÈÖçÁΩÆ...</p>
                </div>
            </div>
        </div>

        <!-- Á≥ªÁªüÊó•Âøó -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Á≥ªÁªüÊó•Âøó</h2>
                <div>
                    <button class="btn btn-secondary" id="refreshLogsBtn">
                        üîÑ Âà∑Êñ∞Êó•Âøó
                    </button>
                    <button class="btn btn-danger" id="clearLogsBtn">
                        üóëÔ∏è Ê∏ÖÁ©∫Êó•Âøó
                    </button>
                </div>
            </div>
            <div id="logsContainer" class="logs-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Ê≠£Âú®Âä†ËΩΩÊó•Âøó...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëURLÊ®°ÊÄÅÊ°Ü -->
    <div class="modal" id="urlModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Ê∑ªÂä†URLÈÖçÁΩÆ</h3>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="urlForm">
                    <div class="form-group">
                        <label for="urlId">ÈÖçÁΩÆID</label>
                        <input type="text" class="form-control" id="urlId" required>
                    </div>
                    <div class="form-group">
                        <label for="urlAddress">URLÂú∞ÂùÄ</label>
                        <input type="url" class="form-control" id="urlAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="urlMethod">ËØ∑Ê±ÇÊñπÊ≥ï</label>
                        <select class="form-control" id="urlMethod">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="intervalSeconds">ËÆøÈóÆÈó¥ÈöîÔºàÁßíÔºâ</label>
                        <input type="number" class="form-control" id="intervalSeconds" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="randomRange">ÈöèÊú∫ÂÅèÁßªÔºàÁßíÔºâ</label>
                        <input type="number" class="form-control" id="randomRange" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="urlEnabled" checked>
                            ÂêØÁî®Ê≠§URL
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="urlHeaders">ËØ∑Ê±ÇÂ§¥ÔºàJSONÊ†ºÂºèÔºâ</label>
                        <textarea class="form-control" id="urlHeaders" rows="3" placeholder='{"Content-Type": "application/json"}'></textarea>
                    </div>
                    <div class="form-group">
                        <label for="urlData">ËØ∑Ê±Ç‰ΩìÔºàJSONÊ†ºÂºèÔºåPOST/PUTÊó∂‰ΩøÁî®Ôºâ</label>
                        <textarea class="form-control" id="urlData" rows="3" placeholder='{"key": "value"}'></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelModalBtn">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-primary" id="saveUrlBtn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script>
        // Èò≤Ê≠¢Êó†ÈôêÂà∑Êñ∞ÁöÑ‰øùÊä§Êú∫Âà∂
        (function() {
            const reloadCount = parseInt(window.sessionStorage.getItem('reload-count') || '0');
            const lastReloadTime = parseInt(window.sessionStorage.getItem('last-reload-time') || '0');
            const now = Date.now();

            if (reloadCount > 5 && (now - lastReloadTime) < 3000) {
                console.error('Ê£ÄÊµãÂà∞Êó†ÈôêÂà∑Êñ∞ÔºåÂÅúÊ≠¢È°µÈù¢Âä†ËΩΩ');
                window.stop();
                document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>Ê£ÄÊµãÂà∞Êó†ÈôêÂà∑Êñ∞</h1><p>È°µÈù¢Â∑≤Ë¢´ÂÅúÊ≠¢Âä†ËΩΩ‰ª•‰øùÊä§ÊµèËßàÂô®„ÄÇ</p><button id="resetBtn">ÈáçÁΩÆÂπ∂ÈáçÊñ∞Âä†ËΩΩ</button></div>';
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        window.sessionStorage.clear();
                        location.reload();
                    });
                }
                return;
            }

            if ((now - lastReloadTime) < 1000) {
                window.sessionStorage.setItem('reload-count', (reloadCount + 1).toString());
            } else {
                window.sessionStorage.setItem('reload-count', '1');
            }
            window.sessionStorage.setItem('last-reload-time', now.toString());
        })();

        let urls = [];
        let editingUrlId = null;
        let logsInterval = null; // Áî®‰∫éÂ≠òÂÇ®Êó•ÂøóÂÆöÊó∂Âô®ÁöÑID

        // ÁªëÂÆöÂä®ÊÄÅÁîüÊàêÊåâÈíÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function bindDynamicButtonEvents() {
            // ÁªëÂÆöÂàáÊç¢ÊåâÈíÆ
            const toggleButtons = document.querySelectorAll('[toggle-btn]');
            console.log('Found toggle buttons:', toggleButtons.length); // Ë∞ÉËØï‰ø°ÊÅØ
            
            toggleButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const urlId = this.getAttribute('data-url-id');
                    const enabled = this.getAttribute('data-enabled') === 'true';
                    console.log('Toggle button clicked:', { urlId, enabled }); // Ë∞ÉËØï‰ø°ÊÅØ
                    toggleUrl(urlId, enabled);
                });
            });

            // ÁªëÂÆöÁºñËæëÊåâÈíÆ
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const urlId = this.getAttribute('data-url-id');
                    editUrl(urlId);
                });
            });

            // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const urlId = this.getAttribute('data-url-id');
                    deleteUrl(urlId);
                });
            });

            // ÁªëÂÆöÁ©∫Áä∂ÊÄÅ‰∏ãÁöÑÊ∑ªÂä†URLÊåâÈíÆ
            const emptyAddUrlBtn = document.getElementById('emptyAddUrlBtn');
            if (emptyAddUrlBtn) {
                emptyAddUrlBtn.addEventListener('click', showAddModal);
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            // Ê∑ªÂä†ÈÄÄÂá∫ÁôªÂΩï‰∫ã‰ª∂ÁõëÂê¨Âô®
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // ÁªëÂÆöÊ∑ªÂä†URLÊåâÈíÆ
            const addUrlBtn = document.getElementById('addUrlBtn');
            if (addUrlBtn) {
                addUrlBtn.addEventListener('click', showAddModal);
            }

            // ÁªëÂÆöÂà∑Êñ∞Êï∞ÊçÆÊåâÈíÆ
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            if (refreshDataBtn) {
                refreshDataBtn.addEventListener('click', refreshData);
            }

            // ÁªëÂÆöÂà∑Êñ∞Êó•ÂøóÊåâÈíÆ
            const refreshLogsBtn = document.getElementById('refreshLogsBtn');
            if (refreshLogsBtn) {
                refreshLogsBtn.addEventListener('click', refreshLogs);
            }

            // ÁªëÂÆöÊ∏ÖÁ©∫Êó•ÂøóÊåâÈíÆ
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', clearLogs);
            }

            // ÁªëÂÆöÊ®°ÊÄÅÊ°ÜÊåâÈíÆ
            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }

            const cancelModalBtn = document.getElementById('cancelModalBtn');
            if (cancelModalBtn) {
                cancelModalBtn.addEventListener('click', closeModal);
            }

            const saveUrlBtn = document.getElementById('saveUrlBtn');
            if (saveUrlBtn) {
                saveUrlBtn.addEventListener('click', saveUrl);
            }

            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadUrls();
                loadLogs();
                
                // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if (logsInterval) {
                    clearInterval(logsInterval);
                }
                
                // ËÆæÁΩÆÊñ∞ÁöÑÊó•ÂøóÂÆöÊó∂Âô®
                logsInterval = setInterval(loadLogs, 30000); // ÊØè30ÁßíÂà∑Êñ∞Êó•Âøó
            }
        });

        // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÂÆöÊó∂Âô®
        window.addEventListener('beforeunload', () => {
            if (logsInterval) {
                clearInterval(logsInterval);
                logsInterval = null;
            }
        });

        // Ê£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.replace('/');
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.replace('/');
                return false;
            }
        }

        // Âä†ËΩΩURLÈÖçÁΩÆ
        async function loadUrls() {
            try {
                const response = await fetch('/api/config/urls');
                const data = await response.json();

                if (response.ok) {
                    urls = data.urls || [];
                    renderUrls();
                    updateStats();
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showError('Âä†ËΩΩURLÈÖçÁΩÆÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Load URLs failed:', error);
                showError('ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïÂä†ËΩΩURLÈÖçÁΩÆ');
            }
        }

        // Ê∏≤ÊüìURLÂàóË°®
        function renderUrls() {
            const urlList = document.getElementById('urlList');

            if (urls.length === 0) {
                urlList.innerHTML = `
                    <div class="empty-state">
                        <h3>ÊöÇÊó†URLÈÖçÁΩÆ</h3>
                        <p>ÁÇπÂáª"Ê∑ªÂä†URL"ÊåâÈíÆÊù•ÂàõÂª∫ÊÇ®ÁöÑÁ¨¨‰∏Ä‰∏™ÂÆöÊó∂ËÆøÈóÆ‰ªªÂä°</p>
                        <button class="btn btn-primary" id="emptyAddUrlBtn">Ê∑ªÂä†URL</button>
                    </div>
                `;
                return;
            }

            const html = urls.map(url => `
                <div class="url-item">
                    <div class="url-header">
                        <span class="url-id">${url.id}</span>
                        <div class="url-status">
                            <span class="status-badge ${url.enabled ? 'status-enabled' : 'status-disabled'}">
                                ${url.enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}
                            </span>
                            <button class="btn btn-sm ${url.enabled ? 'btn-danger' : 'btn-success'}"
                                    toggle-btn data-url-id="${url.id}" data-enabled="${url.enabled ? 'false' : 'true'}">
                                ${url.enabled ? 'Á¶ÅÁî®' : 'ÂêØÁî®'}
                            </button>
                            <button class="btn btn-sm btn-primary edit-btn" data-url-id="${url.id}">ÁºñËæë</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-url-id="${url.id}">Âà†Èô§</button>
                        </div>
                    </div>
                    <div class="url-details">
                        <div class="detail-item">
                            <span class="detail-label">URLÂú∞ÂùÄ</span>
                            <span class="detail-value">${url.url}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ËØ∑Ê±ÇÊñπÊ≥ï</span>
                            <span class="detail-value">${url.method}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ËÆøÈóÆÈó¥Èöî</span>
                            <span class="detail-value">${url.intervalSeconds}Áßí ¬±${url.randomRange}Áßí</span>
                        </div>
                    </div>
                </div>
            `).join('');

            urlList.innerHTML = html;

            // ÈáçÊñ∞ÁªëÂÆöÂä®ÊÄÅÁîüÊàêÊåâÈíÆÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            bindDynamicButtonEvents();
        }

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats() {
            const totalUrls = urls.length;
            const enabledUrls = urls.filter(url => url.enabled).length;
            const disabledUrls = totalUrls - enabledUrls;

            document.getElementById('totalUrls').textContent = totalUrls;
            document.getElementById('enabledUrls').textContent = enabledUrls;
            document.getElementById('disabledUrls').textContent = disabledUrls;
        }

        // ÊòæÁ§∫Ê∑ªÂä†URLÊ®°ÊÄÅÊ°Ü
        function showAddModal() {
            editingUrlId = null;
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†URLÈÖçÁΩÆ';
            document.getElementById('urlForm').reset();
            document.getElementById('urlEnabled').checked = true;
            document.getElementById('urlModal').style.display = 'block';
        }

        // ÁºñËæëURL
        function editUrl(urlId) {
            const url = urls.find(u => u.id === urlId);
            if (!url) return;

            editingUrlId = urlId;
            document.getElementById('modalTitle').textContent = 'ÁºñËæëURLÈÖçÁΩÆ';
            document.getElementById('urlId').value = url.id;
            document.getElementById('urlAddress').value = url.url;
            document.getElementById('urlMethod').value = url.method;
            document.getElementById('intervalSeconds').value = url.intervalSeconds;
            document.getElementById('randomRange').value = url.randomRange || 0;
            document.getElementById('urlEnabled').checked = url.enabled;
            document.getElementById('urlHeaders').value = url.headers ? JSON.stringify(url.headers, null, 2) : '';
            document.getElementById('urlData').value = url.data ? JSON.stringify(url.data, null, 2) : '';
            document.getElementById('urlModal').style.display = 'block';
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            document.getElementById('urlModal').style.display = 'none';
            editingUrlId = null;
        }

        // ‰øùÂ≠òURL
        async function saveUrl() {
            // ÂÖàÊ£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
            if (!await checkAuth()) return;

            try {
                const urlId = document.getElementById('urlId').value.trim();
                const urlAddress = document.getElementById('urlAddress').value.trim();
                const urlMethod = document.getElementById('urlMethod').value;
                const intervalSeconds = parseInt(document.getElementById('intervalSeconds').value);
                const randomRange = parseInt(document.getElementById('randomRange').value) || 0;
                const urlEnabled = document.getElementById('urlEnabled').checked;

                let headers = {};
                let data = {};

                try {
                    const headersText = document.getElementById('urlHeaders').value.trim();
                    if (headersText) {
                        headers = JSON.parse(headersText);
                    }
                } catch (error) {
                    alert('ËØ∑Ê±ÇÂ§¥Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ËæìÂÖ•ÊúâÊïàÁöÑJSON');
                    return;
                }

                try {
                    const dataText = document.getElementById('urlData').value.trim();
                    if (dataText) {
                        data = JSON.parse(dataText);
                    }
                } catch (error) {
                    alert('ËØ∑Ê±Ç‰ΩìÊ†ºÂºè‰∏çÊ≠£Á°ÆÔºåËØ∑ËæìÂÖ•ÊúâÊïàÁöÑJSON');
                    return;
                }

                const urlConfig = {
                    id: urlId,
                    url: urlAddress,
                    method: urlMethod,
                    intervalSeconds: intervalSeconds,
                    randomRange: randomRange,
                    enabled: urlEnabled,
                    headers: Object.keys(headers).length > 0 ? headers : undefined,
                    data: (urlMethod === 'POST' || urlMethod === 'PUT') && Object.keys(data).length > 0 ? data : undefined
                };

                let updatedUrls = [...urls];

                if (editingUrlId) {
                    // ÁºñËæëÁé∞ÊúâURL
                    const index = urls.findIndex(u => u.id === editingUrlId);
                    if (index !== -1) {
                        updatedUrls[index] = urlConfig;
                    }
                } else {
                    // Ê∑ªÂä†Êñ∞URL
                    if (urls.find(u => u.id === urlId)) {
                        alert('ÈÖçÁΩÆIDÂ∑≤Â≠òÂú®ÔºåËØ∑‰ΩøÁî®‰∏çÂêåÁöÑID');
                        return;
                    }
                    updatedUrls.push(urlConfig);
                }

                const response = await fetch('/api/config/urls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ urls: updatedUrls })
                });

                const result = await response.json();

                if (response.ok) {
                    closeModal();
                    loadUrls();
                    showAlert('URLÈÖçÁΩÆ‰øùÂ≠òÊàêÂäü', 'success');
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showAlert(result.error || '‰øùÂ≠òÂ§±Ë¥•', 'danger');
                }
            } catch (error) {
                console.error('Save URL failed:', error);
                showAlert('ÁΩëÁªúÈîôËØØÔºå‰øùÂ≠òÂ§±Ë¥•', 'danger');
            }
        }

        // ÂàáÊç¢URLÂêØÁî®Áä∂ÊÄÅ
        async function toggleUrl(urlId, enabled) {
            // ÂÖàÊ£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
            if (!await checkAuth()) return;

            console.log('Toggle URL called:', { urlId, enabled }); // Ë∞ÉËØï‰ø°ÊÅØ

            try {
                const response = await fetch(`/api/tasks/${urlId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enabled })
                });

                const result = await response.json();
                console.log('Toggle URL response:', { status: response.status, result }); // Ë∞ÉËØï‰ø°ÊÅØ

                if (response.ok) {
                    loadUrls();
                    showAlert(result.message || `‰ªªÂä°Â∑≤${enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®'}`, 'success');
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showAlert(result.error || 'Êìç‰ΩúÂ§±Ë¥•', 'danger');
                }
            } catch (error) {
                console.error('Toggle URL failed:', error);
                showAlert('ÁΩëÁªúÈîôËØØÔºåÊìç‰ΩúÂ§±Ë¥•', 'danger');
            }
        }

        // Âà†Èô§URL
        async function deleteUrl(urlId) {
            // ÂÖàÊ£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
            if (!await checkAuth()) return;

            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§URLÈÖçÁΩÆ "${urlId}" ÂêóÔºü`)) {
                return;
            }

            try {
                const updatedUrls = urls.filter(u => u.id !== urlId);

                const response = await fetch('/api/config/urls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ urls: updatedUrls })
                });

                const result = await response.json();

                if (response.ok) {
                    loadUrls();
                    showAlert('URLÈÖçÁΩÆÂà†Èô§ÊàêÂäü', 'success');
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showAlert(result.error || 'Âà†Èô§Â§±Ë¥•', 'danger');
                }
            } catch (error) {
                console.error('Delete URL failed:', error);
                showAlert('ÁΩëÁªúÈîôËØØÔºåÂà†Èô§Â§±Ë¥•', 'danger');
            }
        }

        // Âä†ËΩΩÊó•Âøó
        async function loadLogs() {
            try {
                const response = await fetch(`/api/logs?type=combined&lines=50&t=${Date.now()}`);
                const data = await response.json();

                const logsContainer = document.getElementById('logsContainer');

                if (response.ok && data.logs && data.logs.length > 0) {
                    const logsHtml = data.logs.map(log => {
                        try {
                            const logObj = JSON.parse(log);
                            const timestamp = new Date(logObj.timestamp).toLocaleString('zh-CN');
                            const level = logObj.level || 'info';
                            const message = logObj.message || log;

                            return `<div style="padding: 0.5rem; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.85rem;">
                                <span style="color: #666; margin-right: 1rem;">${timestamp}</span>
                                <span style="color: ${level === 'error' ? '#dc3545' : level === 'warn' ? '#ffc107' : '#28a745'}; margin-right: 1rem;">[${level.toUpperCase()}]</span>
                                <span>${message}</span>
                            </div>`;
                        } catch (e) {
                            return `<div style="padding: 0.5rem; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.85rem;">${log}</div>`;
                        }
                    }).join('');

                    logsContainer.innerHTML = logsHtml;
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    logsContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">ÊöÇÊó†Êó•ÂøóËÆ∞ÂΩï</div>';
                }
            } catch (error) {
                console.error('Load logs failed:', error);
                document.getElementById('logsContainer').innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc3545;">Âä†ËΩΩÊó•ÂøóÂ§±Ë¥•</div>';
            }
        }

        // Âà∑Êñ∞Êó•Âøó
        function refreshLogs() {
            loadLogs();
        }

        // Ê∏ÖÁ©∫Êó•Âøó
        async function clearLogs() {
            // ÂÖàÊ£ÄÊü•ËÆ§ËØÅÁä∂ÊÄÅ
            if (!await checkAuth()) return;

            if (!confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊó•ÂøóÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                return;
            }

            try {
                const response = await fetch('/api/logs/clear', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('logsContainer').innerHTML = '<div style="padding: 2rem; text-align: center; color: #28a745;">Êó•ÂøóÂ∑≤Ê∏ÖÁ©∫</div>';
                    showAlert('Êó•ÂøóÊ∏ÖÁ©∫ÊàêÂäü', 'success');
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showAlert(result.error || 'Ê∏ÖÁ©∫Êó•ÂøóÂ§±Ë¥•', 'danger');
                }
            } catch (error) {
                console.error('Clear logs failed:', error);
                showAlert('ÁΩëÁªúÈîôËØØÔºåÊ∏ÖÁ©∫Êó•ÂøóÂ§±Ë¥•', 'danger');
            }
        }

        // Âà∑Êñ∞Êï∞ÊçÆ
        function refreshData() {
            loadUrls();
            loadLogs();
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        async function logout() {
            try {
                // Ê∏ÖÁêÜÂÆöÊó∂Âô®
                if (logsInterval) {
                    clearInterval(logsInterval);
                    logsInterval = null;
                }
                
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.replace('/login.html');
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.replace('/login.html');
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
        function showAlert(message, type) {
            // ÂàõÂª∫ÊèêÁ§∫ÂÖÉÁ¥†
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '2000';
            alert.style.maxWidth = '400px';

            document.body.appendChild(alert);

            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }

        // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
        function showError(message) {
            showAlert(message, 'danger');
        }

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modal = document.getElementById('urlModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>