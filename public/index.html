<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Fangwen - ç®¡ç†ç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo h1 {
            font-size: 1.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .url-list {
            padding: 1.5rem;
        }

        .url-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }

        .url-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
        }

        .url-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .url-id {
            font-weight: 600;
            color: #333;
        }

        .url-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-enabled {
            background: #d4edda;
            color: #155724;
        }

        .status-disabled {
            background: #f8d7da;
            color: #721c24;
        }

        .url-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            color: #666;
            font-size: 0.9rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            word-break: break-all;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            margin: 5% auto;
            position: relative;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .alert {
            padding: 0.75rem 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .container {
                padding: 0 0.5rem;
            }

            .url-details {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
        }

        /* æ—¥å¿—å®¹å™¨æ ·å¼ */
        .logs-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #fff;
            padding: 1rem;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .logs-container::-webkit-scrollbar {
            width: 8px;
        }

        .logs-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .logs-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .logs-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>ğŸ¤– Auto-Fangwen</h1>
                <span>å®šæ—¶è®¿é—®URLç®¡ç†ç³»ç»Ÿ</span>
            </div>
            <div class="user-info">
                <span>ç®¡ç†å‘˜</span>
                <button class="btn btn-secondary btn-sm" id="logoutBtn">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalUrls">0</div>
                <div class="stat-label">æ€»URLæ•°é‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enabledUrls">0</div>
                <div class="stat-label">å¯ç”¨ä»»åŠ¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="disabledUrls">0</div>
                <div class="stat-label">ç¦ç”¨ä»»åŠ¡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="systemStatus">è¿è¡Œä¸­</div>
                <div class="stat-label">ç³»ç»ŸçŠ¶æ€</div>
            </div>
        </div>

        <!-- URLé…ç½®ç®¡ç† -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">URLé…ç½®ç®¡ç†</h2>
                <div>
                    <button class="btn btn-primary" id="addUrlBtn">
                        â• æ·»åŠ URL
                    </button>
                    <button class="btn btn-secondary" id="refreshDataBtn">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
            </div>
            <div class="url-list" id="urlList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½URLé…ç½®...</p>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿæ—¥å¿— -->
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">ç³»ç»Ÿæ—¥å¿—</h2>
                <div>
                    <button class="btn btn-secondary" id="refreshLogsBtn">
                        ğŸ”„ åˆ·æ–°æ—¥å¿—
                    </button>
                    <button class="btn btn-danger" id="clearLogsBtn">
                        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>
            <div id="logsContainer" class="logs-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½æ—¥å¿—...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘URLæ¨¡æ€æ¡† -->
    <div class="modal" id="urlModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">æ·»åŠ URLé…ç½®</h3>
                <button class="modal-close" id="closeModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <form id="urlForm">
                    <div class="form-group">
                        <label for="urlId">é…ç½®ID</label>
                        <input type="text" class="form-control" id="urlId" required>
                    </div>
                    <div class="form-group">
                        <label for="urlAddress">URLåœ°å€</label>
                        <input type="url" class="form-control" id="urlAddress" required>
                    </div>
                    <div class="form-group">
                        <label for="urlMethod">è¯·æ±‚æ–¹æ³•</label>
                        <select class="form-control" id="urlMethod">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="intervalSeconds">è®¿é—®é—´éš”ï¼ˆç§’ï¼‰</label>
                        <input type="number" class="form-control" id="intervalSeconds" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="randomRange">éšæœºåç§»ï¼ˆç§’ï¼‰</label>
                        <input type="number" class="form-control" id="randomRange" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="urlEnabled" checked>
                            å¯ç”¨æ­¤URL
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="urlHeaders">è¯·æ±‚å¤´ï¼ˆJSONæ ¼å¼ï¼‰</label>
                        <textarea class="form-control" id="urlHeaders" rows="3" placeholder='{"Content-Type": "application/json"}'></textarea>
                    </div>
                    <div class="form-group">
                        <label for="urlData">è¯·æ±‚ä½“ï¼ˆJSONæ ¼å¼ï¼ŒPOST/PUTæ—¶ä½¿ç”¨ï¼‰</label>
                        <textarea class="form-control" id="urlData" rows="3" placeholder='{"key": "value"}'></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelModalBtn">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="saveUrlBtn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // é˜²æ­¢æ— é™åˆ·æ–°çš„ä¿æŠ¤æœºåˆ¶
        (function() {
            const reloadCount = parseInt(window.sessionStorage.getItem('reload-count') || '0');
            const lastReloadTime = parseInt(window.sessionStorage.getItem('last-reload-time') || '0');
            const now = Date.now();

            if (reloadCount > 5 && (now - lastReloadTime) < 3000) {
                console.error('æ£€æµ‹åˆ°æ— é™åˆ·æ–°ï¼Œåœæ­¢é¡µé¢åŠ è½½');
                window.stop();
                document.body.innerHTML = '<div style="padding: 20px; text-align: center;"><h1>æ£€æµ‹åˆ°æ— é™åˆ·æ–°</h1><p>é¡µé¢å·²è¢«åœæ­¢åŠ è½½ä»¥ä¿æŠ¤æµè§ˆå™¨ã€‚</p><button id="resetBtn">é‡ç½®å¹¶é‡æ–°åŠ è½½</button></div>';
                const resetBtn = document.getElementById('resetBtn');
                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        window.sessionStorage.clear();
                        location.reload();
                    });
                }
                return;
            }

            if ((now - lastReloadTime) < 1000) {
                window.sessionStorage.setItem('reload-count', (reloadCount + 1).toString());
            } else {
                window.sessionStorage.setItem('reload-count', '1');
            }
            window.sessionStorage.setItem('last-reload-time', now.toString());
        })();

        let urls = [];
        let editingUrlId = null;
        let logsInterval = null; // ç”¨äºå­˜å‚¨æ—¥å¿—å®šæ—¶å™¨çš„ID

        // ç»‘å®šåŠ¨æ€ç”ŸæˆæŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
        function bindDynamicButtonEvents() {
            // ç»‘å®šåˆ‡æ¢æŒ‰é’®
            const toggleButtons = document.querySelectorAll('[toggle-btn]');
            console.log('Found toggle buttons:', toggleButtons.length); // è°ƒè¯•ä¿¡æ¯
            
            toggleButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const urlId = this.getAttribute('data-url-id');
                    const enabled = this.getAttribute('data-enabled') === 'true';
                    console.log('Toggle button clicked:', { urlId, enabled }); // è°ƒè¯•ä¿¡æ¯
                    toggleUrl(urlId, enabled);
                });
            });

            // ç»‘å®šç¼–è¾‘æŒ‰é’®
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const urlId = this.getAttribute('data-url-id');
                    editUrl(urlId);
                });
            });

            // ç»‘å®šåˆ é™¤æŒ‰é’®
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const urlId = this.getAttribute('data-url-id');
                    deleteUrl(urlId);
                });
            });

            // ç»‘å®šç©ºçŠ¶æ€ä¸‹çš„æ·»åŠ URLæŒ‰é’®
            const emptyAddUrlBtn = document.getElementById('emptyAddUrlBtn');
            if (emptyAddUrlBtn) {
                emptyAddUrlBtn.addEventListener('click', showAddModal);
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            // æ·»åŠ é€€å‡ºç™»å½•äº‹ä»¶ç›‘å¬å™¨
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // ç»‘å®šæ·»åŠ URLæŒ‰é’®
            const addUrlBtn = document.getElementById('addUrlBtn');
            if (addUrlBtn) {
                addUrlBtn.addEventListener('click', showAddModal);
            }

            // ç»‘å®šåˆ·æ–°æ•°æ®æŒ‰é’®
            const refreshDataBtn = document.getElementById('refreshDataBtn');
            if (refreshDataBtn) {
                refreshDataBtn.addEventListener('click', refreshData);
            }

            // ç»‘å®šåˆ·æ–°æ—¥å¿—æŒ‰é’®
            const refreshLogsBtn = document.getElementById('refreshLogsBtn');
            if (refreshLogsBtn) {
                refreshLogsBtn.addEventListener('click', refreshLogs);
            }

            // ç»‘å®šæ¸…ç©ºæ—¥å¿—æŒ‰é’®
            const clearLogsBtn = document.getElementById('clearLogsBtn');
            if (clearLogsBtn) {
                clearLogsBtn.addEventListener('click', clearLogs);
            }

            // ç»‘å®šæ¨¡æ€æ¡†æŒ‰é’®
            const closeModalBtn = document.getElementById('closeModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeModal);
            }

            const cancelModalBtn = document.getElementById('cancelModalBtn');
            if (cancelModalBtn) {
                cancelModalBtn.addEventListener('click', closeModal);
            }

            const saveUrlBtn = document.getElementById('saveUrlBtn');
            if (saveUrlBtn) {
                saveUrlBtn.addEventListener('click', saveUrl);
            }

            const isAuthenticated = await checkAuth();
            if (isAuthenticated) {
                loadUrls();
                loadLogs();
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (logsInterval) {
                    clearInterval(logsInterval);
                }
                
                // è®¾ç½®æ–°çš„æ—¥å¿—å®šæ—¶å™¨
                logsInterval = setInterval(loadLogs, 30000); // æ¯30ç§’åˆ·æ–°æ—¥å¿—
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (logsInterval) {
                clearInterval(logsInterval);
                logsInterval = null;
            }
        });

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();

                if (!data.authenticated) {
                    window.location.replace('/');
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.replace('/');
                return false;
            }
        }

        // åŠ è½½URLé…ç½®
        async function loadUrls() {
            try {
                const response = await fetch('/api/config/urls');
                const data = await response.json();

                if (response.ok) {
                    urls = data.urls || [];
                    renderUrls();
                    updateStats();
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showError('åŠ è½½URLé…ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('Load URLs failed:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•åŠ è½½URLé…ç½®');
            }
        }

        // æ¸²æŸ“URLåˆ—è¡¨
        function renderUrls() {
            const urlList = document.getElementById('urlList');

            if (urls.length === 0) {
                urlList.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— URLé…ç½®</h3>
                        <p>ç‚¹å‡»"æ·»åŠ URL"æŒ‰é’®æ¥åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå®šæ—¶è®¿é—®ä»»åŠ¡</p>
                        <button class="btn btn-primary" id="emptyAddUrlBtn">æ·»åŠ URL</button>
                    </div>
                `;
                return;
            }

            const html = urls.map(url => `
                <div class="url-item">
                    <div class="url-header">
                        <span class="url-id">${url.id}</span>
                        <div class="url-status">
                            <span class="status-badge ${url.enabled ? 'status-enabled' : 'status-disabled'}">
                                ${url.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                            </span>
                            <button class="btn btn-sm ${url.enabled ? 'btn-danger' : 'btn-success'}"
                                    toggle-btn data-url-id="${url.id}" data-enabled="${url.enabled ? 'false' : 'true'}">
                                ${url.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}
                            </button>
                            <button class="btn btn-sm btn-primary edit-btn" data-url-id="${url.id}">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger delete-btn" data-url-id="${url.id}">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="url-details">
                        <div class="detail-item">
                            <span class="detail-label">URLåœ°å€</span>
                            <span class="detail-value">${url.url}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">è¯·æ±‚æ–¹æ³•</span>
                            <span class="detail-value">${url.method}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">è®¿é—®é—´éš”</span>
                            <span class="detail-value">${url.intervalSeconds}ç§’ Â±${url.randomRange}ç§’</span>
                        </div>
                    </div>
                </div>
            `).join('');

            urlList.innerHTML = html;

            // é‡æ–°ç»‘å®šåŠ¨æ€ç”ŸæˆæŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
            bindDynamicButtonEvents();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalUrls = urls.length;
            const enabledUrls = urls.filter(url => url.enabled).length;
            const disabledUrls = totalUrls - enabledUrls;

            document.getElementById('totalUrls').textContent = totalUrls;
            document.getElementById('enabledUrls').textContent = enabledUrls;
            document.getElementById('disabledUrls').textContent = disabledUrls;
        }

        // æ˜¾ç¤ºæ·»åŠ URLæ¨¡æ€æ¡†
        function showAddModal() {
            editingUrlId = null;
            document.getElementById('modalTitle').textContent = 'æ·»åŠ URLé…ç½®';
            document.getElementById('urlForm').reset();
            document.getElementById('urlEnabled').checked = true;
            document.getElementById('urlModal').style.display = 'block';
        }

        // ç¼–è¾‘URL
        function editUrl(urlId) {
            const url = urls.find(u => u.id === urlId);
            if (!url) return;

            editingUrlId = urlId;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘URLé…ç½®';
            document.getElementById('urlId').value = url.id;
            document.getElementById('urlAddress').value = url.url;
            document.getElementById('urlMethod').value = url.method;
            document.getElementById('intervalSeconds').value = url.intervalSeconds;
            document.getElementById('randomRange').value = url.randomRange || 0;
            document.getElementById('urlEnabled').checked = url.enabled;
            document.getElementById('urlHeaders').value = url.headers ? JSON.stringify(url.headers, null, 2) : '';
            document.getElementById('urlData').value = url.data ? JSON.stringify(url.data, null, 2) : '';
            document.getElementById('urlModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('urlModal').style.display = 'none';
            editingUrlId = null;
        }

        // ä¿å­˜URL
        async function saveUrl() {
            // å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!await checkAuth()) return;

            try {
                const urlId = document.getElementById('urlId').value.trim();
                const urlAddress = document.getElementById('urlAddress').value.trim();
                const urlMethod = document.getElementById('urlMethod').value;
                const intervalSeconds = parseInt(document.getElementById('intervalSeconds').value);
                const randomRange = parseInt(document.getElementById('randomRange').value) || 0;
                const urlEnabled = document.getElementById('urlEnabled').checked;

                let headers = {};
                let data = {};

                try {
                    const headersText = document.getElementById('urlHeaders').value.trim();
                    if (headersText) {
                        headers = JSON.parse(headersText);
                    }
                } catch (error) {
                    alert('è¯·æ±‚å¤´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
                    return;
                }

                try {
                    const dataText = document.getElementById('urlData').value.trim();
                    if (dataText) {
                        data = JSON.parse(dataText);
                    }
                } catch (error) {
                    alert('è¯·æ±‚ä½“æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„JSON');
                    return;
                }

                const urlConfig = {
                    id: urlId,
                    url: urlAddress,
                    method: urlMethod,
                    intervalSeconds: intervalSeconds,
                    randomRange: randomRange,
                    enabled: urlEnabled,
                    headers: Object.keys(headers).length > 0 ? headers : undefined,
                    data: (urlMethod === 'POST' || urlMethod === 'PUT') && Object.keys(data).length > 0 ? data : undefined
                };

                let updatedUrls = [...urls];

                if (editingUrlId) {
                    // ç¼–è¾‘ç°æœ‰URL
                    const index = urls.findIndex(u => u.id === editingUrlId);
                    if (index !== -1) {
                        updatedUrls[index] = urlConfig;
                    }
                } else {
                    // æ·»åŠ æ–°URL
                    if (urls.find(u => u.id === urlId)) {
                        alert('é…ç½®IDå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨ä¸åŒçš„ID');
                        return;
                    }
                    updatedUrls.push(urlConfig);
                }

                const response = await fetch('/api/config/urls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ urls: updatedUrls })
                });

                const result = await response.json();

                if (response.ok) {
                    closeModal();
                    loadUrls();
                    showAlert('URLé…ç½®ä¿å­˜æˆåŠŸ', 'success');
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showAlert(result.error || 'ä¿å­˜å¤±è´¥', 'danger');
                }
            } catch (error) {
                console.error('Save URL failed:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œä¿å­˜å¤±è´¥', 'danger');
            }
        }

        // åˆ‡æ¢URLå¯ç”¨çŠ¶æ€
        async function toggleUrl(urlId, enabled) {
            // å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!await checkAuth()) return;

            console.log('Toggle URL called:', { urlId, enabled }); // è°ƒè¯•ä¿¡æ¯

            try {
                const response = await fetch(`/api/tasks/${urlId}/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enabled })
                });

                const result = await response.json();
                console.log('Toggle URL response:', { status: response.status, result }); // è°ƒè¯•ä¿¡æ¯

                if (response.ok) {
                    loadUrls();
                    showAlert(result.message || `ä»»åŠ¡å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showAlert(result.error || 'æ“ä½œå¤±è´¥', 'danger');
                }
            } catch (error) {
                console.error('Toggle URL failed:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œæ“ä½œå¤±è´¥', 'danger');
            }
        }

        // åˆ é™¤URL
        async function deleteUrl(urlId) {
            // å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!await checkAuth()) return;

            if (!confirm(`ç¡®å®šè¦åˆ é™¤URLé…ç½® "${urlId}" å—ï¼Ÿ`)) {
                return;
            }

            try {
                const updatedUrls = urls.filter(u => u.id !== urlId);

                const response = await fetch('/api/config/urls', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ urls: updatedUrls })
                });

                const result = await response.json();

                if (response.ok) {
                    loadUrls();
                    showAlert('URLé…ç½®åˆ é™¤æˆåŠŸ', 'success');
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showAlert(result.error || 'åˆ é™¤å¤±è´¥', 'danger');
                }
            } catch (error) {
                console.error('Delete URL failed:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œåˆ é™¤å¤±è´¥', 'danger');
            }
        }

        // åŠ è½½æ—¥å¿—
        async function loadLogs() {
            try {
                const response = await fetch(`/api/logs?type=combined&lines=50&t=${Date.now()}`);
                const data = await response.json();

                const logsContainer = document.getElementById('logsContainer');

                if (response.ok && data.logs && data.logs.length > 0) {
                    const logsHtml = data.logs.map(log => {
                        try {
                            const logObj = JSON.parse(log);
                            const timestamp = new Date(logObj.timestamp).toLocaleString('zh-CN');
                            const level = logObj.level || 'info';
                            const message = logObj.message || log;

                            return `<div style="padding: 0.5rem; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.85rem;">
                                <span style="color: #666; margin-right: 1rem;">${timestamp}</span>
                                <span style="color: ${level === 'error' ? '#dc3545' : level === 'warn' ? '#ffc107' : '#28a745'}; margin-right: 1rem;">[${level.toUpperCase()}]</span>
                                <span>${message}</span>
                            </div>`;
                        } catch (e) {
                            return `<div style="padding: 0.5rem; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.85rem;">${log}</div>`;
                        }
                    }).join('');

                    logsContainer.innerHTML = logsHtml;
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    logsContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">æš‚æ— æ—¥å¿—è®°å½•</div>';
                }
            } catch (error) {
                console.error('Load logs failed:', error);
                document.getElementById('logsContainer').innerHTML = '<div style="padding: 2rem; text-align: center; color: #dc3545;">åŠ è½½æ—¥å¿—å¤±è´¥</div>';
            }
        }

        // åˆ·æ–°æ—¥å¿—
        function refreshLogs() {
            loadLogs();
        }

        // æ¸…ç©ºæ—¥å¿—
        async function clearLogs() {
            // å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!await checkAuth()) return;

            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }

            try {
                const response = await fetch('/api/logs/clear', {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    document.getElementById('logsContainer').innerHTML = '<div style="padding: 2rem; text-align: center; color: #28a745;">æ—¥å¿—å·²æ¸…ç©º</div>';
                    showAlert('æ—¥å¿—æ¸…ç©ºæˆåŠŸ', 'success');
                } else {
                    if (response.status === 401) {
                        window.location.replace('/');
                        return;
                    }
                    showAlert(result.error || 'æ¸…ç©ºæ—¥å¿—å¤±è´¥', 'danger');
                }
            } catch (error) {
                console.error('Clear logs failed:', error);
                showAlert('ç½‘ç»œé”™è¯¯ï¼Œæ¸…ç©ºæ—¥å¿—å¤±è´¥', 'danger');
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadUrls();
            loadLogs();
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            try {
                // æ¸…ç†å®šæ—¶å™¨
                if (logsInterval) {
                    clearInterval(logsInterval);
                    logsInterval = null;
                }
                
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.replace('/login.html');
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.replace('/login.html');
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            // åˆ›å»ºæç¤ºå…ƒç´ 
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '2000';
            alert.style.maxWidth = '400px';

            document.body.appendChild(alert);

            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            showAlert(message, 'danger');
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('urlModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>